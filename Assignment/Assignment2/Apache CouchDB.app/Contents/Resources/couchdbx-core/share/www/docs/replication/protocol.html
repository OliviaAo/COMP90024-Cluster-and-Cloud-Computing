<!--

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed
under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.

-->

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>4.2. CouchDB Replication Protocol &mdash; Apache CouchDB 2.0 Documentation</title>
    
    <link rel="stylesheet" href="../_static/rtd.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="top" title="Apache CouchDB 2.0 Documentation" href="../index.html" />
    <link rel="up" title="4. Replication" href="index.html" />
    <link rel="next" title="4.3. Replicator Database" href="replicator.html" />
    <link rel="prev" title="4.1. Introduction to Replication" href="intro.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../http-api.html" title="HTTP API Reference"
             >API Reference</a></li>
        <li class="right" >
          <a href="../config-ref.html" title="Configuration Reference"
             >Config Reference</a> |</li>
        <li class="right" >
          <a href="replicator.html" title="4.3. Replicator Database"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="intro.html" title="4.1. Introduction to Replication"
             accesskey="P">previous</a> |</li>
  <li><a href="../index.html">Apache CouchDB 2.0 Documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">4. Replication</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="couchdb-replication-protocol">
<span id="replication-protocol"></span><h1>4.2. CouchDB Replication Protocol<a class="headerlink" href="#couchdb-replication-protocol" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Version:</th><td class="field-body">3</td>
</tr>
</tbody>
</table>
<p>The <cite>CouchDB Replication Protocol</cite> is a protocol for synchronising JSON
documents between 2 peers over HTTP/1.1 by using the public <a class="reference internal" href="../api/index.html#api"><em>CouchDB REST
API</em></a> and is based on the Apache CouchDB <a class="reference external" href="http://en.wikipedia.org/wiki/Multiversion_concurrency_control">MVCC</a> Data model.</p>
<div class="section" id="preface">
<h2>4.2.1. Preface<a class="headerlink" href="#preface" title="Permalink to this headline">¶</a></h2>
<div class="section" id="language">
<h3>Language<a class="headerlink" href="#language" title="Permalink to this headline">¶</a></h3>
<p>The key words &#8220;MUST&#8221;, &#8220;MUST NOT&#8221;, &#8220;REQUIRED&#8221;, &#8220;SHALL&#8221;, &#8220;SHALL NOT&#8221;,
&#8220;SHOULD&#8221;, &#8220;SHOULD NOT&#8221;, &#8220;RECOMMENDED&#8221;, &#8220;MAY&#8221;, and &#8220;OPTIONAL&#8221; in this
document are to be interpreted as described in <span class="target" id="index-0"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2119.html"><strong>RFC 2119</strong></a>.</p>
</div>
<div class="section" id="goals">
<h3>Goals<a class="headerlink" href="#goals" title="Permalink to this headline">¶</a></h3>
<p>The primary goal of this specification is to describe the <cite>CouchDB Replication
Protocol</cite> under the hood.</p>
<p>The secondary goal is to provide enough detailed information about the protocol
to make it easy to build tools on any language and platform that can synchronize
data with CouchDB.</p>
</div>
<div class="section" id="definitions">
<h3>Definitions<a class="headerlink" href="#definitions" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>JSON:</dt>
<dd><abbr title="JavaScript Object Notation">JSON</abbr> is a text format for the
serialization of structured data. It is described in <a class="reference external" href="http://www.ecma-international.org/publications/files/ecma-st/ECMA-262.pdf">ECMA-262</a> and
<span class="target" id="index-1"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc4627.html"><strong>RFC 4627</strong></a>.</dd>
<dt>URI:</dt>
<dd>A URI is defined by <span class="target" id="index-2"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc3986.html"><strong>RFC 3986</strong></a>. It can be a URL as defined
in <span class="target" id="index-3"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc1738.html"><strong>RFC 1738</strong></a>.</dd>
<dt>ID:</dt>
<dd>An identifier (could be a UUID) as described in <span class="target" id="index-4"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc4122.html"><strong>RFC 4122</strong></a>.</dd>
<dt>Revision:</dt>
<dd>A <a class="reference external" href="http://en.wikipedia.org/wiki/Multiversion_concurrency_control">MVCC</a> token value of following pattern: <tt class="docutils literal"><span class="pre">N-sig</span></tt> where <tt class="docutils literal"><span class="pre">N</span></tt> is ALWAYS
a positive integer and <tt class="docutils literal"><span class="pre">sig</span></tt> is the Document signature (custom).
Don&#8217;t mix it up with the revision in version control systems!</dd>
<dt>Leaf Revision:</dt>
<dd>The last Document Revision in a series of changes. Documents may have
multiple Leaf Revisions (aka Conflict Revisions) due to concurrent updates.</dd>
<dt>Document:</dt>
<dd>A document is a JSON object with an ID and Revision defined in <tt class="docutils literal"><span class="pre">_id</span></tt> and
<tt class="docutils literal"><span class="pre">_rev</span></tt> fields respectively. A Document&#8217;s ID MUST be unique within
the Database where it is stored.</dd>
<dt>Database:</dt>
<dd>A collection of Documents with a unique URI.</dd>
<dt>Changes Feed:</dt>
<dd>A stream of Document-changing events (create, update, delete) for
the specified Database.</dd>
<dt>Sequence ID:</dt>
<dd>An ID provided by the Changes Feed. It MUST be incremental,
but MAY NOT always be an integer.</dd>
<dt>Source:</dt>
<dd>Database from where the Documents are replicated.</dd>
<dt>Target:</dt>
<dd>Database where the Documents are replicated to.</dd>
<dt>Replication:</dt>
<dd>The one-way directed synchronization process of Source and Target endpoints.</dd>
<dt>Checkpoint:</dt>
<dd>Intermediate Recorded Sequence ID used for Replication recovery.</dd>
<dt>Replicator:</dt>
<dd>A service or an application which initiates and runs Replication.</dd>
<dt>Filter Function:</dt>
<dd>A special function of any programming language that is used to filter
Documents during Replication (see <a class="reference internal" href="../couchapp/ddocs.html#filterfun"><em>Filter Functions</em></a>)</dd>
<dt>Filter Function Name:</dt>
<dd>An ID of a Filter Function that may be used as a symbolic reference (aka
callback function) to apply the related Filter Function to Replication.</dd>
<dt>Filtered Replication:</dt>
<dd>Replication of Documents from Source to Target using a Filter Function.</dd>
<dt>Full Replication:</dt>
<dd>Replication of all Documents from Source to Target.</dd>
<dt>Push Replication:</dt>
<dd>Replication process where Source is a local endpoint and Target is remote.</dd>
<dt>Pull Replication:</dt>
<dd>Replication process where Source is a remote endpoint and Target is local.</dd>
<dt>Continuous Replication:</dt>
<dd>Replication that &#8220;never stops&#8221;: after processing all events from the
Changes Feed, the Replicator doesn&#8217;t close the connection, but awaits new
change events from the Source. The connection is kept alive by periodic
heartbeats.</dd>
<dt>Replication Log:</dt>
<dd>A special Document that holds Replication history (recorded Checkpoints
and a few more statistics) between Source and Target.</dd>
<dt>Replication ID:</dt>
<dd>A unique value that unambiguously identifies the Replication Log.</dd>
</dl>
</div>
</div>
<div class="section" id="replication-protocol-algorithm">
<h2>4.2.2. Replication Protocol Algorithm<a class="headerlink" href="#replication-protocol-algorithm" title="Permalink to this headline">¶</a></h2>
<p>The <cite>CouchDB Replication Protocol</cite> is not <em>magical</em>, but
an agreement on usage of the public <a class="reference internal" href="../api/index.html#api"><em>CouchDB HTTP REST API</em></a> to
enable Documents to be replicated from Source to Target.</p>
<p>The reference implementation, written in <a class="reference external" href="http://erlang.org">Erlang</a>, is provided by the
<a class="reference external" href="https://github.com/apache/couchdb/tree/master/src/couch_replicator">couch_replicator</a> module in Apache CouchDB.</p>
<p>It is RECOMMENDED that one follow this algorithm specification, use the same
HTTP endpoints, and run requests with the same parameters to provide a
completely compatible implementation. Custom Replicator implementations MAY use
different HTTP API endpoints and request parameters depending on their local
specifics and they MAY implement only part of the Replication Protocol to run
only Push or Pull Replication. However, while such solutions could also run the
Replication process, they loose compatibility with the CouchDB Replicator.</p>
<div class="section" id="verify-peers">
<h3>Verify Peers<a class="headerlink" href="#verify-peers" title="Permalink to this headline">¶</a></h3>
<div class="highlight-text"><div class="highlight"><pre>+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
&#39; Verify Peers:                                                             &#39;
&#39;                                                                           &#39;
&#39;                404 Not Found   +--------------------------------+         &#39;
&#39;       +----------------------- |     Check Source Existence     |         &#39;
&#39;       |                        +--------------------------------+         &#39;
&#39;       |                        |          HEAD /source          |         &#39;
&#39;       |                        +--------------------------------+         &#39;
&#39;       |                          |                                        &#39;
&#39;       |                          | 200 OK                                 &#39;
&#39;       |                          v                                        &#39;
&#39;       |                        +--------------------------------+         &#39;
&#39;       |                        |     Check Target Existence     | ----+   &#39;
&#39;       |                        +--------------------------------+     |   &#39;
&#39;       |                        |         HEAD /target           |     |   &#39;
&#39;       |                        +--------------------------------+     |   &#39;
&#39;       |                          |                                    |   &#39;
&#39;       |                          | 404 Not Found                      |   &#39;
&#39;       v                          v                                    |   &#39;
&#39;   +-------+    No              +--------------------------------+     |   &#39;
&#39;   | Abort | &lt;----------------- |         Create Target?         |     |   &#39;
&#39;   +-------+                    +--------------------------------+     |   &#39;
&#39;       ^                          |                                    |   &#39;
&#39;       |                          | Yes                                |   &#39;
&#39;       |                          v                                    |   &#39;
&#39;       |        Failure         +--------------------------------+     |   &#39;
&#39;       +----------------------- |          Create Target         |     |   &#39;
&#39;                                +--------------------------------+     |   &#39;
&#39;                                |           PUT /target          |     |   &#39;
&#39;                                +--------------------------------+     |   &#39;
&#39;                                  |                                    |   &#39;
&#39;                                  | 201 Created                 200 OK |   &#39;
&#39;                                  |                                    |   &#39;
+ - - - - - - - - - - - - - - - -  | - - - - - - - - - - - - - - - - -  | - +
                                   |                                    |
+ - - - - - - - - - - - - - - - -  | - - - - - - - - - - - - - - - - -  | - +
&#39; Get Peers Information:           |                                    |   &#39;
&#39;                                  +------------------------------------+   &#39;
&#39;                                  |                                        &#39;
&#39;                                  v                                        &#39;
&#39;                                +--------------------------------+         &#39;
&#39;                                |     Get Source Information     |         &#39;
&#39;                                +--------------------------------+         &#39;
&#39;                                                                           &#39;
+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
</pre></div>
</div>
<p>The Replicator MUST ensure that both Source and Target exist
by using <a class="reference internal" href="../api/database/common.html#head--db" title="HEAD /{db}"><tt class="xref http http-head docutils literal"><span class="pre">HEAD</span> <span class="pre">/{db}</span></tt></a> requests.</p>
<div class="section" id="check-source-existence">
<h4>Check Source Existence<a class="headerlink" href="#check-source-existence" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">HEAD</span> <span class="nn">/source</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">CouchDB</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 05 Oct 2013 08:50:39 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="check-target-existence">
<h4>Check Target Existence<a class="headerlink" href="#check-target-existence" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">HEAD</span> <span class="nn">/target</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">CouchDB</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 05 Oct 2013 08:51:11 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="create-target">
<h4>Create Target?<a class="headerlink" href="#create-target" title="Permalink to this headline">¶</a></h4>
<p>In case of a non-existent Target, the Replicator MAY make a <a class="reference internal" href="../api/database/common.html#put--db" title="PUT /{db}"><tt class="xref http http-put docutils literal"><span class="pre">PUT</span> <span class="pre">/{db}</span></tt></a>
request to create the Target:</p>
<blockquote>
<div><p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">PUT</span> <span class="nn">/target</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">CouchDB</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">12</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 05 Oct 2013 08:58:41 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>However, the Replicator&#8217;s PUT request MAY NOT succeeded due to insufficient
privileges (which are granted by the provided credential) and so receive a
<a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> or a <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.4">403 Forbidden</a> error. Such errors SHOULD be expected
and well handled:</p>
<blockquote>
<div><div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">500</span> <span class="ne">Internal Server Error</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">108</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Fri, 09 May 2014 13:50:32 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;unauthorized&quot;</span><span class="p">,</span>
    <span class="nt">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;unauthorized to access or create database http://localhost:5984/target&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="abort">
<h4>Abort<a class="headerlink" href="#abort" title="Permalink to this headline">¶</a></h4>
<p>In case of a non-existent Source or Target, Replication SHOULD be aborted with
an HTTP error response:</p>
<blockquote>
<div><div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">500</span> <span class="ne">Internal Server Error</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">56</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 05 Oct 2013 08:55:29 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;db_not_found&quot;</span><span class="p">,</span>
    <span class="nt">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;could not open source&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="get-peers-information">
<h3>Get Peers Information<a class="headerlink" href="#get-peers-information" title="Permalink to this headline">¶</a></h3>
<div class="highlight-text"><div class="highlight"><pre>+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -+
&#39; Verify Peers:                                                    &#39;
&#39;                         +------------------------+               &#39;
&#39;                         | Check Target Existence |               &#39;
&#39;                         +------------------------+               &#39;
&#39;                                     |                            &#39;
&#39;                                     | 200 OK                     &#39;
&#39;                                     |                            &#39;
+ - - - - - - - - - - - - - - - - - - | - - - - - - - - - - - - - -+
                                      |
+ - - - - - - - - - - - - - - - - - - | - - - - - - - - - - - - - -+
&#39; Get Peers Information:              |                            &#39;
&#39;                                     v                            &#39;
&#39;                         +------------------------+               &#39;
&#39;                         | Get Source Information |               &#39;
&#39;                         +------------------------+               &#39;
&#39;                         |      GET /source       |               &#39;
&#39;                         +------------------------+               &#39;
&#39;                                     |                            &#39;
&#39;                                     | 200 OK                     &#39;
&#39;                                     v                            &#39;
&#39;                         +------------------------+               &#39;
&#39;                         | Get Target Information |               &#39;
&#39;                         +------------------------+               &#39;
&#39;                         |      GET /target       |               &#39;
&#39;                         +------------------------+               &#39;
&#39;                                     |                            &#39;
&#39;                                     | 200 OK                     &#39;
&#39;                                     |                            &#39;
+ - - - - - - - - - - - - - - - - - - | - - - - - - - - - - - - - -+
                                      |
+ - - - - - - - - - - - - - - - - - - | - - - - - - - - - - - - - -+
&#39; Find Common Ancestry:               |                            &#39;
&#39;                                     |                            &#39;
&#39;                                     v                            &#39;
&#39;                         +-------------------------+              &#39;
&#39;                         | Generate Replication ID |              &#39;
&#39;                         +-------------------------+              &#39;
&#39;                                                                  &#39;
+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -+
</pre></div>
</div>
<p>The Replicator retrieves basic information both from Source and Target using
<a class="reference internal" href="../api/database/common.html#get--db" title="GET /{db}"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}</span></tt></a> requests. The GET response MUST contain JSON objects with
the following mandatory fields:</p>
<ul class="simple">
<li><strong>instance_start_time</strong> (<em>string</em>): Timestamp when the Database was
opened, expressed in <em>microseconds</em> since the epoch.</li>
<li><strong>update_seq</strong> (<em>number</em> / <em>string</em>): The current database Sequence ID.</li>
</ul>
<p>Any other fields are optional. The information that the Replicator needs
is the <tt class="docutils literal"><span class="pre">update_seq</span></tt> field: this value will be used to define a <em>temporary</em>
(because Database data is subject to change) upper bound for changes feed
listening and statistic calculating to show proper Replication progress.</p>
<div class="section" id="get-source-information">
<h4>Get Source Information<a class="headerlink" href="#get-source-information" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/source</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">CouchDB</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">256</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Tue, 08 Oct 2013 07:53:08 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;committed_update_seq&quot;</span><span class="p">:</span> <span class="mi">61772</span><span class="p">,</span>
    <span class="nt">&quot;compact_running&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nt">&quot;data_size&quot;</span><span class="p">:</span> <span class="mi">70781613961</span><span class="p">,</span>
    <span class="nt">&quot;db_name&quot;</span><span class="p">:</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span>
    <span class="nt">&quot;disk_format_version&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="nt">&quot;disk_size&quot;</span><span class="p">:</span> <span class="mi">79132913799</span><span class="p">,</span>
    <span class="nt">&quot;doc_count&quot;</span><span class="p">:</span> <span class="mi">41961</span><span class="p">,</span>
    <span class="nt">&quot;doc_del_count&quot;</span><span class="p">:</span> <span class="mi">3807</span><span class="p">,</span>
    <span class="nt">&quot;instance_start_time&quot;</span><span class="p">:</span> <span class="s2">&quot;1380901070238216&quot;</span><span class="p">,</span>
    <span class="nt">&quot;purge_seq&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&quot;update_seq&quot;</span><span class="p">:</span> <span class="mi">61772</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="get-target-information">
<h4>Get Target Information<a class="headerlink" href="#get-target-information" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/target/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">CouchDB</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">363</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Tue, 08 Oct 2013 12:37:01 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;compact_running&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nt">&quot;db_name&quot;</span><span class="p">:</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span>
    <span class="nt">&quot;disk_format_version&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="nt">&quot;disk_size&quot;</span><span class="p">:</span> <span class="mi">77001455</span><span class="p">,</span>
    <span class="nt">&quot;doc_count&quot;</span><span class="p">:</span> <span class="mi">1832</span><span class="p">,</span>
    <span class="nt">&quot;doc_del_count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&quot;instance_start_time&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
    <span class="nt">&quot;other&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;data_size&quot;</span><span class="p">:</span> <span class="mi">50829452</span>
    <span class="p">},</span>
    <span class="nt">&quot;purge_seq&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&quot;update_seq&quot;</span><span class="p">:</span> <span class="s2">&quot;1841-g1AAAADveJzLYWBgYMlgTmGQT0lKzi9KdUhJMtbLSs1LLUst0k&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="find-common-ancestry">
<h3>Find Common Ancestry<a class="headerlink" href="#find-common-ancestry" title="Permalink to this headline">¶</a></h3>
<div class="highlight-text"><div class="highlight"><pre>+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
&#39; Get Peers Information:                                                    &#39;
&#39;                                                                           &#39;
&#39;                             +-------------------------------------------+ &#39;
&#39;                             |           Get Target Information          | &#39;
&#39;                             +-------------------------------------------+ &#39;
&#39;                               |                                           &#39;
+ - - - - - - - - - - - - - - - | - - - - - - - - - - - - - - - - - - - - - +
                                |
+ - - - - - - - - - - - - - - - | - - - - - - - - - - - - - - - - - - - - - +
&#39; Find Common Ancestry:         v                                           &#39;
&#39;                             +-------------------------------------------+ &#39;
&#39;                             |          Generate Replication ID          | &#39;
&#39;                             +-------------------------------------------+ &#39;
&#39;                               |                                           &#39;
&#39;                               |                                           &#39;
&#39;                               v                                           &#39;
&#39;                             +-------------------------------------------+ &#39;
&#39;                             |      Get Replication Log from Source      | &#39;
&#39;                             +-------------------------------------------+ &#39;
&#39;                             |     GET /source/_local/replication-id     | &#39;
&#39;                             +-------------------------------------------+ &#39;
&#39;                               |                                           &#39;
&#39;                               | 200 OK                                    &#39;
&#39;                               | 404 Not Found                             &#39;
&#39;                               v                                           &#39;
&#39;                             +-------------------------------------------+ &#39;
&#39;                             |      Get Replication Log from Target      | &#39;
&#39;                             +-------------------------------------------+ &#39;
&#39;                             |     GET /target/_local/replication-id     | &#39;
&#39;                             +-------------------------------------------+ &#39;
&#39;                               |                                           &#39;
&#39;                               | 200 OK                                    &#39;
&#39;                               | 404 Not Found                             &#39;
&#39;                               v                                           &#39;
&#39;                             +-------------------------------------------+ &#39;
&#39;                             |          Compare Replication Logs         | &#39;
&#39;                             +-------------------------------------------+ &#39;
&#39;                               |                                           &#39;
&#39;                               | Use latest common sequence as start point &#39;
&#39;                               |                                           &#39;
+ - - - - - - - - - - - - - - - | - - - - - - - - - - - - - - - - - - - - - +
                                |
                                |
+ - - - - - - - - - - - - - - - | - - - - - - - - - - - - - - - - - - - - - +
&#39; Locate Changed Documents:     |                                           &#39;
&#39;                               |                                           &#39;
&#39;                               v                                           &#39;
&#39;                             +-------------------------------------------+ &#39;
&#39;                             |        Listen Source Changes Feed         | &#39;
&#39;                             +-------------------------------------------+ &#39;
&#39;                                                                           &#39;
+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
</pre></div>
</div>
<div class="section" id="generate-replication-id">
<h4>Generate Replication ID<a class="headerlink" href="#generate-replication-id" title="Permalink to this headline">¶</a></h4>
<p>Before Replication is started, the Replicator MUST generate a Replication ID.
This value is used to track Replication History, resume and continue previously
interrupted Replication process.</p>
<p>The Replication ID generation algorithm is implementation specific. Whatever
algorithm is used it MUST uniquely identify the Replication process. CouchDB&#8217;s
Replicator, for example, uses the following factors in generating a Replication
ID:</p>
<ul class="simple">
<li>Persistent Peer UUID value. For CouchDB, the local
<a class="reference internal" href="../config/couchdb.html#couchdb/uuid" title="uuid"><tt class="xref config config-option docutils literal"><span class="pre">Server</span> <span class="pre">UUID</span></tt></a> is used</li>
<li>Source and Target URI and if Source or Target are local or remote Databases</li>
<li>If Target needed to be created</li>
<li>If Replication is Continuous</li>
<li>OAuth headers if any</li>
<li>Any custom headers</li>
<li><a class="reference internal" href="../couchapp/ddocs.html#filterfun"><em>Filter function</em></a> code if used</li>
<li>Changes Feed query parameters, if any</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">See <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=blob;f=src/couch_replicator/src/couch_replicator_utils.erl;h=d7778db;hb=HEAD">couch_replicator_utils.erl</a> for an example of a Replication ID generation
implementation.</p>
</div>
</div>
<div class="section" id="retrieve-replication-logs-from-source-and-target">
<h4>Retrieve Replication Logs from Source and Target<a class="headerlink" href="#retrieve-replication-logs-from-source-and-target" title="Permalink to this headline">¶</a></h4>
<p>Once the Replication ID has been generated, the Replicator SHOULD retrieve
the Replication Log from both Source and Target using
<a class="reference internal" href="../api/local.html#get--db-_local-docid" title="GET /{db}/_local/{docid}"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}/_local/{docid}</span></tt></a>:</p>
<blockquote>
<div><p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/source/_local/b3e44b920ee2951cb2e123b63044427a</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">CouchDB</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">1019</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Thu, 10 Oct 2013 06:18:56 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;0-8&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;_local/b3e44b920ee2951cb2e123b63044427a&quot;</span><span class="p">,</span>
    <span class="nt">&quot;_rev&quot;</span><span class="p">:</span> <span class="s2">&quot;0-8&quot;</span><span class="p">,</span>
    <span class="nt">&quot;history&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;doc_write_failures&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;docs_read&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;docs_written&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;end_last_seq&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="nt">&quot;end_time&quot;</span><span class="p">:</span> <span class="s2">&quot;Thu, 10 Oct 2013 05:56:38 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;missing_checked&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;missing_found&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;recorded_seq&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="nt">&quot;session_id&quot;</span><span class="p">:</span> <span class="s2">&quot;d5a34cbbdafa70e0db5cb57d02a6b955&quot;</span><span class="p">,</span>
            <span class="nt">&quot;start_last_seq&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="nt">&quot;start_time&quot;</span><span class="p">:</span> <span class="s2">&quot;Thu, 10 Oct 2013 05:56:38 GMT&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;doc_write_failures&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;docs_read&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;docs_written&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;end_last_seq&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="nt">&quot;end_time&quot;</span><span class="p">:</span> <span class="s2">&quot;Thu, 10 Oct 2013 05:56:12 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;missing_checked&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;missing_found&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;recorded_seq&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="nt">&quot;session_id&quot;</span><span class="p">:</span> <span class="s2">&quot;11a79cdae1719c362e9857cd1ddff09d&quot;</span><span class="p">,</span>
            <span class="nt">&quot;start_last_seq&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;start_time&quot;</span><span class="p">:</span> <span class="s2">&quot;Thu, 10 Oct 2013 05:56:12 GMT&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;doc_write_failures&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;docs_read&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;docs_written&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;end_last_seq&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;end_time&quot;</span><span class="p">:</span> <span class="s2">&quot;Thu, 10 Oct 2013 05:56:04 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;missing_checked&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;missing_found&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;recorded_seq&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;session_id&quot;</span><span class="p">:</span> <span class="s2">&quot;77cdf93cde05f15fcb710f320c37c155&quot;</span><span class="p">,</span>
            <span class="nt">&quot;start_last_seq&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;start_time&quot;</span><span class="p">:</span> <span class="s2">&quot;Thu, 10 Oct 2013 05:56:04 GMT&quot;</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&quot;replication_id_version&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="nt">&quot;session_id&quot;</span><span class="p">:</span> <span class="s2">&quot;d5a34cbbdafa70e0db5cb57d02a6b955&quot;</span><span class="p">,</span>
    <span class="nt">&quot;source_last_seq&quot;</span><span class="p">:</span> <span class="mi">5</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>The Replication Log SHOULD contain the following fields:</p>
<ul class="simple">
<li><strong>history</strong> (<em>array</em> of <em>object</em>): Replication history. <strong>Required</strong><ul>
<li><strong>doc_write_failures</strong> (<em>number</em>): Number of failed writes</li>
<li><strong>docs_read</strong> (<em>number</em>): Number of read documents</li>
<li><strong>docs_written</strong> (<em>number</em>): Number of written documents</li>
<li><strong>end_last_seq</strong> (<em>number</em>): Last processed Update Sequence ID</li>
<li><strong>end_time</strong> (<em>string</em>): Replication completion datetime in <span class="target" id="index-5"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc5322.html"><strong>RFC 5322</strong></a>
format</li>
<li><strong>missing_checked</strong> (<em>number</em>): Number of checked revisions on Source</li>
<li><strong>missing_found</strong> (<em>number</em>): Number of missing revisions found on Target</li>
<li><strong>recorded_seq</strong> (<em>number</em>): Recorded intermediate Checkpoint. <strong>Required</strong></li>
<li><strong>session_id</strong> (<em>string</em>): Unique session ID. Commonly, a random UUID value
is used. <strong>Required</strong></li>
<li><strong>start_last_seq</strong> (<em>number</em>): Start update Sequence ID</li>
<li><strong>start_time</strong> (<em>string</em>): Replication start datetime in <span class="target" id="index-6"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc5322.html"><strong>RFC 5322</strong></a> format</li>
</ul>
</li>
<li><strong>replication_id_version</strong> (<em>number</em>): Replication protocol version. Defines
Replication ID calculation algorithm, HTTP API calls and the others
routines. <strong>Required</strong></li>
<li><strong>session_id</strong> (<em>string</em>): Unique ID of the last session. Shortcut to
the <tt class="docutils literal"><span class="pre">session_id</span></tt> field of the latest <tt class="docutils literal"><span class="pre">history</span></tt> object. <strong>Required</strong></li>
<li><strong>source_last_seq</strong> (<em>number</em>): Last processed Checkpoint. Shortcut to
the <tt class="docutils literal"><span class="pre">recorded_seq</span></tt> field of the latest <tt class="docutils literal"><span class="pre">history</span></tt> object. <strong>Required</strong></li>
</ul>
<p>This request MAY fall with a <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 Not Found</a> response:</p>
<blockquote>
<div><p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/source/_local/b6cef528f67aa1a8a014dd1144b10e09</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">CouchDB</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">404</span> <span class="ne">Object Not Found</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">41</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Tue, 08 Oct 2013 13:31:10 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;not_found&quot;</span><span class="p">,</span>
    <span class="nt">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;missing&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>That&#8217;s OK. This means that there is no information about the current Replication
so it must not have been run previously and as such the Replicator MUST run
a Full Replication.</p>
</div>
<div class="section" id="compare-replication-logs">
<h4>Compare Replication Logs<a class="headerlink" href="#compare-replication-logs" title="Permalink to this headline">¶</a></h4>
<p>If the Replication Logs are successfully retrieved from both Source and Target
then the Replicator MUST determine their common ancestry by following the next
algorithm:</p>
<ul class="simple">
<li>Compare <tt class="docutils literal"><span class="pre">session_id</span></tt> values for the chronological last session - if they
match both Source and Target have a common Replication history and it seems
to be valid. Use <tt class="docutils literal"><span class="pre">source_last_seq</span></tt> value for the startup Checkpoint</li>
<li>In case of mismatch, iterate over the <tt class="docutils literal"><span class="pre">history</span></tt> collection to search for
the latest (chronologically) common <tt class="docutils literal"><span class="pre">session_id</span></tt> for Source and Target.
Use value of <tt class="docutils literal"><span class="pre">recorded_seq</span></tt> field as startup Checkpoint</li>
</ul>
<p>If Source and Target has no common ancestry, the Replicator MUST run
Full Replication.</p>
</div>
</div>
<div class="section" id="locate-changed-documents">
<h3>Locate Changed Documents<a class="headerlink" href="#locate-changed-documents" title="Permalink to this headline">¶</a></h3>
<div class="highlight-text"><div class="highlight"><pre>+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
&#39; Find Common Ancestry:                                                     &#39;
&#39;                                                                           &#39;
&#39;             +------------------------------+                              &#39;
&#39;             |   Compare Replication Logs   |                              &#39;
&#39;             +------------------------------+                              &#39;
&#39;                                          |                                &#39;
&#39;                                          |                                &#39;
+ - - - - - - - - - - - - - - - - - - - -  |  - - - - - - - - - - - - - - - +
                                           |
+ - - - - - - - - - - - - - - - - - - - -  |  - - - - - - - - - - - - - - - +
&#39; Locate Changed Documents:                |                                &#39;
&#39;                                          |                                &#39;
&#39;                                          |                                &#39;
&#39;                                          v                                &#39;
&#39;            +-------------------------------+                              &#39;
&#39;   +------&gt; |     Listen to Changes Feed    | -----+                       &#39;
&#39;   |        +-------------------------------+      |                       &#39;
&#39;   |        |     GET  /source/_changes     |      |                       &#39;
&#39;   |        |     POST /source/_changes     |      |                       &#39;
&#39;   |        +-------------------------------+      |                       &#39;
&#39;   |                                      |        |                       &#39;
&#39;   |                                      |        |                       &#39;
&#39;   |                There are new changes |        | No more changes       &#39;
&#39;   |                                      |        |                       &#39;
&#39;   |                                      v        v                       &#39;
&#39;   |        +-------------------------------+    +-----------------------+ &#39;
&#39;   |        |     Read Batch of Changes     |    | Replication Completed | &#39;
&#39;   |        +-------------------------------+    +-----------------------+ &#39;
&#39;   |                                      |                                &#39;
&#39;   | No                                   |                                &#39;
&#39;   |                                      v                                &#39;
&#39;   |        +-------------------------------+                              &#39;
&#39;   |        |  Compare Documents Revisions  |                              &#39;
&#39;   |        +-------------------------------+                              &#39;
&#39;   |        |    POST /target/_revs_diff    |                              &#39;
&#39;   |        +-------------------------------+                              &#39;
&#39;   |                                      |                                &#39;
&#39;   |                               200 OK |                                &#39;
&#39;   |                                      v                                &#39;
&#39;   |        +-------------------------------+                              &#39;
&#39;   +------- |     Any Differences Found?    |                              &#39;
&#39;            +-------------------------------+                              &#39;
&#39;                                          |                                &#39;
&#39;                                      Yes |                                &#39;
&#39;                                          |                                &#39;
+ - - - - - - - - - - - - - - - - - - - -  |  - - - - - - - - - - - - - - - +
                                           |
+ - - - - - - - - - - - - - - - - - - - -  |  - - - - - - - - - - - - - - - +
&#39; Replicate Changes:                       |                                &#39;
&#39;                                          v                                &#39;
&#39;            +-------------------------------+                              &#39;
&#39;            |  Fetch Next Changed Document  |                              &#39;
&#39;            +-------------------------------+                              &#39;
&#39;                                                                           &#39;
+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
</pre></div>
</div>
<div class="section" id="listen-to-changes-feed">
<h4>Listen to Changes Feed<a class="headerlink" href="#listen-to-changes-feed" title="Permalink to this headline">¶</a></h4>
<p>When the start up Checkpoint has been defined, the Replicator SHOULD read
the Source&#8217;s <a class="reference internal" href="../api/database/changes.html#changes"><em>Changes Feed</em></a> by using a <a class="reference internal" href="../api/database/changes.html#get--db-_changes" title="GET /{db}/_changes"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}/_changes</span></tt></a>
request. This request MUST be made with the following query parameters:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">feed</span></tt> parameter defines the Changes Feed response style: for Continuous
Replication the <tt class="docutils literal"><span class="pre">continuous</span></tt> value SHOULD be used, otherwise - <tt class="docutils literal"><span class="pre">normal</span></tt>.</li>
<li><tt class="docutils literal"><span class="pre">style=all_docs</span></tt> query parameter tells the Source that it MUST include
all Revision leaves for each document&#8217;s event in output.</li>
<li>For Continuous Replication the <tt class="docutils literal"><span class="pre">heartbeat</span></tt> parameter defines the heartbeat
period in <em>milliseconds</em>. The RECOMMENDED value by default is <tt class="docutils literal"><span class="pre">10000</span></tt>
(10 seconds).</li>
<li>If a startup Checkpoint was found during the Replication Logs comparison,
the <tt class="docutils literal"><span class="pre">since</span></tt> query parameter MUST be passed with this value.
In case of Full Replication it MAY be <tt class="docutils literal"><span class="pre">0</span></tt> (number zero) or
be omitted.</li>
</ul>
<p>Additionally, the <tt class="docutils literal"><span class="pre">filter</span></tt> query parameter MAY be specified to enable a
<a class="reference internal" href="../api/database/changes.html#changes-filter"><em>filter function</em></a> on Source side. Other
custom parameters MAY also be provided.</p>
</div>
<div class="section" id="read-batch-of-changes">
<h4>Read Batch of Changes<a class="headerlink" href="#read-batch-of-changes" title="Permalink to this headline">¶</a></h4>
<p>Reading the whole feed in a single shot may not be an optimal use of resources.
It is RECOMMENDED to process the feed in small chunks. However, there is
no specific recommendation on chunk size since it is heavily dependent on
available resources: large chunks requires more memory while they reduce
I/O operations and vice versa.</p>
<p>Note, that Changes Feed output format is different for a request with
<a class="reference internal" href="../api/database/changes.html#changes-normal"><em>feed=normal</em></a> and with
<a class="reference internal" href="../api/database/changes.html#changes-continuous"><em>feed=continuous</em></a> query parameter.</p>
<p>Normal Feed:</p>
<blockquote>
<div><p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/source/_changes?feed=normal&amp;style=all_docs&amp;heartbeat=10000</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">CouchDB</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Fri, 09 May 2014 16:20:41 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang OTP)</span>
<span class="na">Transfer-Encoding</span><span class="o">:</span> <span class="l">chunked</span>

<span class="p">{</span><span class="nt">&quot;results&quot;</span><span class="p">:[</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">14</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;f957f41e&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;3-46a3&quot;</span><span class="p">}],</span><span class="nt">&quot;deleted&quot;</span><span class="p">:</span><span class="kc">true</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">29</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;ddf339dd&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;10-304b&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">37</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;d3cc62f5&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;2-eec2&quot;</span><span class="p">}],</span><span class="nt">&quot;deleted&quot;</span><span class="p">:</span><span class="kc">true</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;f13bd08b&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-b35d&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;e0a99867&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;2-c1c6&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">42</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;a75bdfc5&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-967a&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">43</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;a5f467a0&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-5575&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">45</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;470c3004&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;11-c292&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">46</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;b1cb8508&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;10-ABC&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">47</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;49ec0489&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;157-b01f&quot;</span><span class="p">},{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;123-6f7c&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">49</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;dad10379&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-9346&quot;</span><span class="p">},{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;6-5b8a&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;73464877&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-9f08&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">51</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;7ae19302&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-57bf&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">63</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;6a7a6c86&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;5-acf6&quot;</span><span class="p">}],</span><span class="nt">&quot;deleted&quot;</span><span class="p">:</span><span class="kc">true</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">64</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;dfb9850a&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-102f&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">65</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;c532afa7&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-6491&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">66</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;af8a9508&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-3db2&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">67</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;caa3dded&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-6491&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">68</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;79f3b4e9&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-102f&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">69</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;1d89d16f&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-3db2&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">71</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;abae7348&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;2-7051&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">77</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;6c25534f&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;9-CDE&quot;</span><span class="p">},{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;3-00e7&quot;</span><span class="p">},{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-ABC&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">78</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;22-5f95&quot;</span><span class="p">}]}</span>
<span class="p">],</span>
<span class="nt">&quot;last_seq&quot;</span><span class="p">:</span><span class="mi">78</span><span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>Continuous Feed:</p>
<blockquote>
<div><p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/source/_changes?feed=continuous&amp;style=all_docs&amp;heartbeat=10000</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">CouchDB</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Fri, 09 May 2014 16:22:22 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang OTP)</span>
<span class="na">Transfer-Encoding</span><span class="o">:</span> <span class="l">chunked</span>

<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">14</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;f957f41e&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;3-46a3&quot;</span><span class="p">}],</span><span class="nt">&quot;deleted&quot;</span><span class="p">:</span><span class="kc">true</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">29</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;ddf339dd&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;10-304b&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">37</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;d3cc62f5&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;2-eec2&quot;</span><span class="p">}],</span><span class="nt">&quot;deleted&quot;</span><span class="p">:</span><span class="kc">true</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;f13bd08b&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-b35d&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;e0a99867&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;2-c1c6&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">42</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;a75bdfc5&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-967a&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">43</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;a5f467a0&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-5575&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">45</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;470c3004&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;11-c292&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">46</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;b1cb8508&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;10-ABC&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">47</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;49ec0489&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;157-b01f&quot;</span><span class="p">},{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;123-6f7c&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">49</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;dad10379&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-9346&quot;</span><span class="p">},{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;6-5b8a&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;73464877&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-9f08&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">51</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;7ae19302&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-57bf&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">63</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;6a7a6c86&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;5-acf6&quot;</span><span class="p">}],</span><span class="nt">&quot;deleted&quot;</span><span class="p">:</span><span class="kc">true</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">64</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;dfb9850a&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-102f&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">65</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;c532afa7&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-6491&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">66</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;af8a9508&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-3db2&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">67</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;caa3dded&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-6491&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">68</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;79f3b4e9&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-102f&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">69</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;1d89d16f&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-3db2&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">71</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;abae7348&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;2-7051&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">75</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;21-5949&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">77</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;6c255&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;9-CDE&quot;</span><span class="p">},{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;3-00e7&quot;</span><span class="p">},{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-ABC&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">78</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:[{</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;22-5f95&quot;</span><span class="p">}]}</span>
</pre></div>
</div>
</div></blockquote>
<p>For both Changes Feed formats record-per-line style is preserved to simplify
iterative fetching and decoding JSON objects with less memory footprint.</p>
</div>
<div class="section" id="calculate-revision-difference">
<h4>Calculate Revision Difference<a class="headerlink" href="#calculate-revision-difference" title="Permalink to this headline">¶</a></h4>
<p>After reading the batch of changes from the Changes Feed, the Replicator forms a
JSON mapping object for Document ID and related leaf Revisions and sends
the result to Target via a <a class="reference internal" href="../api/database/misc.html#post--db-_revs_diff" title="POST /{db}/_revs_diff"><tt class="xref http http-post docutils literal"><span class="pre">POST</span> <span class="pre">/{db}/_revs_diff</span></tt></a> request:</p>
<blockquote>
<div><p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/target/_revs_diff</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">287</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">CouchDB</span>

<span class="p">{</span>
    <span class="nt">&quot;baz&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;2-7051cbe5c8faecd085a3fa619e6e6337&quot;</span>
    <span class="p">],</span>
    <span class="nt">&quot;foo&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;3-6a540f3d701ac518d3b9733d673c5484&quot;</span>
    <span class="p">],</span>
    <span class="nt">&quot;bar&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;1-d4e501ab47de6b2000fc8a02f84a0c77&quot;</span><span class="p">,</span>
        <span class="s2">&quot;1-967a00dff5e02add41819138abb3284d&quot;</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">88</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Fri, 25 Oct 2013 14:44:41 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;baz&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;missing&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;2-7051cbe5c8faecd085a3fa619e6e6337&quot;</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&quot;bar&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;missing&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;1-d4e501ab47de6b2000fc8a02f84a0c77&quot;</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>In the response the Replicator receives a Document ID &#8211; Revisions mapping,
but only for Revisions that do not exist in Target and are REQUIRED to be
transferred from Source.</p>
<p>If all Revisions in the request match the current state of the Documents then
the response will contain an empty JSON object:</p>
<blockquote>
<div><p><strong>Request</strong></p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/target/_revs_diff</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">160</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">CouchDB</span>

<span class="p">{</span>
    <span class="nt">&quot;foo&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;3-6a540f3d701ac518d3b9733d673c5484&quot;</span>
    <span class="p">],</span>
    <span class="nt">&quot;bar&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;1-967a00dff5e02add41819138abb3284d&quot;</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">2</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Fri, 25 Oct 2013 14:45:00 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{}</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="replication-completed">
<h4>Replication Completed<a class="headerlink" href="#replication-completed" title="Permalink to this headline">¶</a></h4>
<p>When there are no more changes left to process and no more Documents left to
replicate, the Replicator finishes the Replication process. If Replication
wasn&#8217;t Continuous, the Replicator MAY return a response to client with
statistics about the process.</p>
<blockquote>
<div><div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">414</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Fri, 09 May 2014 15:14:19 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;history&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;doc_write_failures&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;docs_read&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;docs_written&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;end_last_seq&quot;</span><span class="p">:</span> <span class="mi">2939</span><span class="p">,</span>
            <span class="nt">&quot;end_time&quot;</span><span class="p">:</span> <span class="s2">&quot;Fri, 09 May 2014 15:14:19 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;missing_checked&quot;</span><span class="p">:</span> <span class="mi">1835</span><span class="p">,</span>
            <span class="nt">&quot;missing_found&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;recorded_seq&quot;</span><span class="p">:</span> <span class="mi">2939</span><span class="p">,</span>
            <span class="nt">&quot;session_id&quot;</span><span class="p">:</span> <span class="s2">&quot;05918159f64842f1fe73e9e2157b2112&quot;</span><span class="p">,</span>
            <span class="nt">&quot;start_last_seq&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;start_time&quot;</span><span class="p">:</span> <span class="s2">&quot;Fri, 09 May 2014 15:14:18 GMT&quot;</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;replication_id_version&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="nt">&quot;session_id&quot;</span><span class="p">:</span> <span class="s2">&quot;05918159f64842f1fe73e9e2157b2112&quot;</span><span class="p">,</span>
    <span class="nt">&quot;source_last_seq&quot;</span><span class="p">:</span> <span class="mi">2939</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="replicate-changes">
<h3>Replicate Changes<a class="headerlink" href="#replicate-changes" title="Permalink to this headline">¶</a></h3>
<div class="highlight-text"><div class="highlight"><pre>+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
&#39; Locate Changed Documents:                                                       &#39;
&#39;                                                                                 &#39;
&#39;               +-------------------------------------+                           &#39;
&#39;               |      Any Differences Found?         |                           &#39;
&#39;               +-------------------------------------+                           &#39;
&#39;                                                   |                             &#39;
&#39;                                                   |                             &#39;
&#39;                                                   |                             &#39;
+ - - - - - - - - - - - - - - - - - - - - - - - - - | - - - - - - - - - - - - - - +
                                                    |
+ - - - - - - - - - - - - - - - - - - - - - - - - - | - - - - - - - - - - - - - - +
&#39; Replicate Changes:                                |                             &#39;
&#39;                                                   v                             &#39;
&#39;               +-------------------------------------+                           &#39;
&#39;   +---------&gt; |     Fetch Next Changed Document     | &lt;---------------------+   &#39;
&#39;   |           +-------------------------------------+                       |   &#39;
&#39;   |           |          GET /source/docid          |                       |   &#39;
&#39;   |           +-------------------------------------+                       |   &#39;
&#39;   |             |                                                           |   &#39;
&#39;   |             |                                                           |   &#39;
&#39;   |             |                                          201 Created      |   &#39;
&#39;   |             | 200 OK                                   401 Unauthorized |   &#39;
&#39;   |             |                                          403 Forbidden    |   &#39;
&#39;   |             |                                                           |   &#39;
&#39;   |             v                                                           |   &#39;
&#39;   |           +-------------------------------------+                       |   &#39;
&#39;   |   +------ |  Document Has Changed Attachments?  |                       |   &#39;
&#39;   |   |       +-------------------------------------+                       |   &#39;
&#39;   |   |         |                                                           |   &#39;
&#39;   |   |         |                                                           |   &#39;
&#39;   |   |         | Yes                                                       |   &#39;
&#39;   |   |         |                                                           |   &#39;
&#39;   |   |         v                                                           |   &#39;
&#39;   |   |       +------------------------+   Yes    +---------------------------+ &#39;
&#39;   |   | No    |  Are They Big Enough?  | -------&gt; | Update Document on Target | &#39;
&#39;   |   |       +------------------------+          +---------------------------+ &#39;
&#39;   |   |         |                                 |     PUT /target/docid     | &#39;
&#39;   |   |         |                                 +---------------------------+ &#39;
&#39;   |   |         |                                                               &#39;
&#39;   |   |         | No                                                            &#39;
&#39;   |   |         |                                                               &#39;
&#39;   |   |         v                                                               &#39;
&#39;   |   |       +-------------------------------------+                           &#39;
&#39;   |   +-----&gt; |     Put Document Into the Stack     |                           &#39;
&#39;   |           +-------------------------------------+                           &#39;
&#39;   |             |                                                               &#39;
&#39;   |             |                                                               &#39;
&#39;   |             v                                                               &#39;
&#39;   |     No    +-------------------------------------+                           &#39;
&#39;   +---------- |           Stack is Full?            |                           &#39;
&#39;   |           +-------------------------------------+                           &#39;
&#39;   |             |                                                               &#39;
&#39;   |             | Yes                                                           &#39;
&#39;   |             |                                                               &#39;
&#39;   |             v                                                               &#39;
&#39;   |           +-------------------------------------+                           &#39;
&#39;   |           | Upload Stack of Documents to Target |                           &#39;
&#39;   |           +-------------------------------------+                           &#39;
&#39;   |           |       POST /target/_bulk_docs       |                           &#39;
&#39;   |           +-------------------------------------+                           &#39;
&#39;   |             |                                                               &#39;
&#39;   |             | 201 Created                                                   &#39;
&#39;   |             v                                                               &#39;
&#39;   |           +-------------------------------------+                           &#39;
&#39;   |           |          Ensure in Commit           |                           &#39;
&#39;   |           +-------------------------------------+                           &#39;
&#39;   |           |  POST /target/_ensure_full_commit   |                           &#39;
&#39;   |           +-------------------------------------+                           &#39;
&#39;   |             |                                                               &#39;
&#39;   |             | 201 Created                                                   &#39;
&#39;   |             v                                                               &#39;
&#39;   |           +-------------------------------------+                           &#39;
&#39;   |           |    Record Replication Checkpoint    |                           &#39;
&#39;   |           +-------------------------------------+                           &#39;
&#39;   |           |  PUT /source/_local/replication-id  |                           &#39;
&#39;   |           |  PUT /target/_local/replication-id  |                           &#39;
&#39;   |           +-------------------------------------+                           &#39;
&#39;   |             |                                                               &#39;
&#39;   |             | 201 Created                                                   &#39;
&#39;   |             v                                                               &#39;
&#39;   |     No    +-------------------------------------+                           &#39;
&#39;   +---------- | All Documents from Batch Processed? |                           &#39;
&#39;               +-------------------------------------+                           &#39;
&#39;                                                   |                             &#39;
&#39;                                               Yes |                             &#39;
&#39;                                                   |                             &#39;
+ - - - - - - - - - - - - - - - - - - - - - - - - - | - - - - - - - - - - - - - - +
                                                    |
+ - - - - - - - - - - - - - - - - - - - - - - - - - | - - - - - - - - - - - - - - +
&#39; Locate Changed Documents:                         |                             &#39;
&#39;                                                   v                             &#39;
&#39;               +-------------------------------------+                           &#39;
&#39;               |       Listen to Changes Feed        |                           &#39;
&#39;               +-------------------------------------+                           &#39;
&#39;                                                                                 &#39;
+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
</pre></div>
</div>
<div class="section" id="fetch-changed-documents">
<h4>Fetch Changed Documents<a class="headerlink" href="#fetch-changed-documents" title="Permalink to this headline">¶</a></h4>
<p>At this step the Replicator MUST fetch all Document Leaf Revisions from Source
that are missed at Target. This operation is effective if Replication WILL
use previously calculated Revision differences since they define
missing Documents and their Revisions.</p>
<p>To fetch the Document the Replicator will make a <a class="reference internal" href="../api/document/common.html#get--db-docid" title="GET /{db}/{docid}"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}/{docid}</span></tt></a> request
with the following query parameters:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">revs=true</span></tt>: Instructs the Source to include the list of all known revisions
into the Document in the <tt class="docutils literal"><span class="pre">_revisions</span></tt> field. This information is needed to
synchronize the Document&#8217;s ancestors history between Source and Target</li>
<li>The <tt class="docutils literal"><span class="pre">open_revs</span></tt> query parameter contains a JSON array with a list of
Leaf Revisions that are needed to be fetched. If the specified Revision
exists then the Document MUST be returned for this Revision. Otherwise,
Source MUST return an object with the single field <tt class="docutils literal"><span class="pre">missing</span></tt> with the
missed Revision as the value. In case the Document contains attachments,
Source MUST return information only for those ones that had been changed
(added or updated) since the specified Revision values. If an attachment
was deleted, the Document MUST NOT have stub information for it</li>
<li><tt class="docutils literal"><span class="pre">latest=true</span></tt>: Ensures, that Source will return the latest Document Revision
regardless of which one was specified in the <tt class="docutils literal"><span class="pre">open_revs</span></tt> query parameter.
This parameter solves a race condition problem where the requested Document
may be changed in between this step and handling related events on the
Changes Feed</li>
</ul>
<p>In the response Source SHOULD return <em class="mimetype">multipart/mixed</em> or respond
instead with <em class="mimetype">application/json</em> unless the <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> header
specifies a different mime type. The <em class="mimetype">multipart/mixed</em> content type
allows handling the response data as a stream, since there could be multiple
documents (one per each Leaf Revision) plus several attachments. These
attachments are mostly binary and JSON has no way to handle such data except as
base64 encoded strings which are very ineffective for transfer and processing
operations.</p>
<p>With a <em class="mimetype">multipart/mixed</em> response the Replicator handles multiple
Document Leaf Revisions and their attachments one by one as raw data without
any additional encoding applied. There is also one agreement to make data
processing more effective: the Document ALWAYS goes before its attachments, so
the Replicator has no need to process all the data to map related
Documents-Attachments and may handle it as stream with lesser memory footprint.</p>
<blockquote>
<div><p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/source/SpaghettiWithMeatballs?revs=true&amp;open_revs=[%225-00ecbbc%22,%221-917fa23%22,%223-6bcedf1%22]&amp;latest=true</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">multipart/mixed</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">CouchDB</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">multipart/mixed; boundary=&quot;7b1596fc4940bc1be725ad67f11ec1c4&quot;</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Thu, 07 Nov 2013 15:10:16 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang OTP)</span>
<span class="na">Transfer-Encoding</span><span class="o">:</span> <span class="l">chunked</span>

--7b1596fc4940bc1be725ad67f11ec1c4
Content-Type: application/json

{
    &quot;_id&quot;: &quot;SpaghettiWithMeatballs&quot;,
    &quot;_rev&quot;: &quot;1-917fa23&quot;,
    &quot;_revisions&quot;: {
        &quot;ids&quot;: [
            &quot;917fa23&quot;
        ],
        &quot;start&quot;: 1
    },
    &quot;description&quot;: &quot;An Italian-American delicious dish&quot;,
    &quot;ingredients&quot;: [
        &quot;spaghetti&quot;,
        &quot;tomato sauce&quot;,
        &quot;meatballs&quot;
    ],
    &quot;name&quot;: &quot;Spaghetti with meatballs&quot;
}
--7b1596fc4940bc1be725ad67f11ec1c4
Content-Type: multipart/related; boundary=&quot;a81a77b0ca68389dda3243a43ca946f2&quot;

--a81a77b0ca68389dda3243a43ca946f2
Content-Type: application/json

{
    &quot;_attachments&quot;: {
      &quot;recipe.txt&quot;: {
          &quot;content_type&quot;: &quot;text/plain&quot;,
          &quot;digest&quot;: &quot;md5-R5CrCb6fX10Y46AqtNn0oQ==&quot;,
          &quot;follows&quot;: true,
          &quot;length&quot;: 87,
          &quot;revpos&quot;: 7
      }
    },
    &quot;_id&quot;: &quot;SpaghettiWithMeatballs&quot;,
    &quot;_rev&quot;: &quot;7-474f12e&quot;,
    &quot;_revisions&quot;: {
        &quot;ids&quot;: [
            &quot;474f12e&quot;,
            &quot;5949cfc&quot;,
            &quot;00ecbbc&quot;,
            &quot;fc997b6&quot;,
            &quot;3552c87&quot;,
            &quot;404838b&quot;,
            &quot;5defd9d&quot;,
            &quot;dc1e4be&quot;
        ],
        &quot;start&quot;: 7
    },
    &quot;description&quot;: &quot;An Italian-American delicious dish&quot;,
    &quot;ingredients&quot;: [
        &quot;spaghetti&quot;,
        &quot;tomato sauce&quot;,
        &quot;meatballs&quot;,
        &quot;love&quot;
    ],
    &quot;name&quot;: &quot;Spaghetti with meatballs&quot;
}
--a81a77b0ca68389dda3243a43ca946f2
Content-Disposition: attachment; filename=&quot;recipe.txt&quot;
Content-Type: text/plain
Content-Length: 87

1. Cook spaghetti
2. Cook meetballs
3. Mix them
4. Add tomato sauce
5. ...
6. PROFIT!

--a81a77b0ca68389dda3243a43ca946f2--
--7b1596fc4940bc1be725ad67f11ec1c4
Content-Type: application/json; error=&quot;true&quot;

{&quot;missing&quot;:&quot;3-6bcedf1&quot;}
--7b1596fc4940bc1be725ad67f11ec1c4--
</pre></div>
</div>
</div></blockquote>
<p>After receiving the response, the Replicator puts all the received data into a
local stack for further bulk upload to utilize network bandwidth effectively.
The local stack size could be limited by number of Documents or bytes of
handled JSON data. When the stack is full the Replicator uploads all the
handled Document in bulk mode to the Target. While bulk operations are highly
RECOMMENDED to be used, in certain cases the Replicator MAY upload Documents to
Target one by one.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Alternative Replicator implementations MAY use alternative ways to retrieve
Documents from Source. For instance, <a class="reference external" href="https://github.com/daleharvey/pouchdb/blob/master/src/pouch.replicate.js">PouchDB</a> doesn&#8217;t uses Multipart API
and fetches only latest Document Revision with inline attachments as single
JSON object. While this is still valid CouchDB HTTP API usage, such
solutions MAY require a different API implementation for non-CouchDB
Peers.</p>
</div>
</div>
<div class="section" id="upload-batch-of-changed-documents">
<h4>Upload Batch of Changed Documents<a class="headerlink" href="#upload-batch-of-changed-documents" title="Permalink to this headline">¶</a></h4>
<p>To upload multiple Documents in a single shot the Replicator sends a
<a class="reference internal" href="../api/database/bulk-api.html#post--db-_bulk_docs" title="POST /{db}/_bulk_docs"><tt class="xref http http-post docutils literal"><span class="pre">POST</span> <span class="pre">/{db}/_bulk_docs</span></tt></a> request to Target with payload containing a JSON object
with the following mandatory fields:</p>
<ul class="simple">
<li><strong>docs</strong> (<em>array</em> of <em>objects</em>): List of Document objects to update on Target.
These Documents MUST contain the <tt class="docutils literal"><span class="pre">_revisions</span></tt> field that holds a list of the
full Revision history to let Target create Leaf Revisions that correctly
preserve ancestry</li>
<li><strong>new_edits</strong> (<em>boolean</em>): Special flag that instructs Target to store
Documents with the specified Revision (field <tt class="docutils literal"><span class="pre">_rev</span></tt>) value as-is without
generating a new revision. Always <tt class="docutils literal"><span class="pre">false</span></tt></li>
</ul>
<p>The request also MAY contain <strong>X-Couch-Full-Commit</strong> that controls
CouchDB <a class="reference internal" href="../config/couchdb.html#couchdb/delayed_commits" title="delayed_commits"><tt class="xref config config-option docutils literal"><span class="pre">commit</span> <span class="pre">policy</span></tt></a>. Other Peers
MAY ignore this header or use it to control similar local
feature.</p>
<blockquote>
<div><p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/target/_bulk_docs</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">826</span>
<span class="na">Content-Type</span><span class="o">:</span><span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">CouchDB</span>
<span class="na">X-Couch-Full-Commit</span><span class="o">:</span> <span class="l">false</span>

<span class="p">{</span>
    <span class="nt">&quot;docs&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span>
            <span class="nt">&quot;_rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-917fa2381192822767f010b95b45325b&quot;</span><span class="p">,</span>
            <span class="nt">&quot;_revisions&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;ids&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;917fa2381192822767f010b95b45325b&quot;</span>
                <span class="p">],</span>
                <span class="nt">&quot;start&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">},</span>
            <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;An Italian-American delicious dish&quot;</span><span class="p">,</span>
            <span class="nt">&quot;ingredients&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;spaghetti&quot;</span><span class="p">,</span>
                <span class="s2">&quot;tomato sauce&quot;</span><span class="p">,</span>
                <span class="s2">&quot;meatballs&quot;</span>
            <span class="p">],</span>
            <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Spaghetti with meatballs&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;LambStew&quot;</span><span class="p">,</span>
            <span class="nt">&quot;_rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-34c318924a8f327223eed702ddfdc66d&quot;</span><span class="p">,</span>
            <span class="nt">&quot;_revisions&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;ids&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;34c318924a8f327223eed702ddfdc66d&quot;</span>
                <span class="p">],</span>
                <span class="nt">&quot;start&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">},</span>
            <span class="nt">&quot;servings&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="nt">&quot;subtitle&quot;</span><span class="p">:</span> <span class="s2">&quot;Delicious with scone topping&quot;</span><span class="p">,</span>
            <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Lamb Stew&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;FishStew&quot;</span><span class="p">,</span>
            <span class="nt">&quot;_rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-9c65296036141e575d32ba9c034dd3ee&quot;</span><span class="p">,</span>
            <span class="nt">&quot;_revisions&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;ids&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;9c65296036141e575d32ba9c034dd3ee&quot;</span>
                <span class="p">],</span>
                <span class="nt">&quot;start&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">},</span>
            <span class="nt">&quot;servings&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="nt">&quot;subtitle&quot;</span><span class="p">:</span> <span class="s2">&quot;Delicious with fresh bread&quot;</span><span class="p">,</span>
            <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Fish Stew&quot;</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&quot;new_edits&quot;</span><span class="p">:</span> <span class="kc">false</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>In its response Target MUST return a JSON array with a list of Document update
statuses. If the Document has been stored successfully, the list item MUST
contain the field <tt class="docutils literal"><span class="pre">ok</span></tt> with <tt class="docutils literal"><span class="pre">true</span></tt> value. Otherwise it MUST contain
<tt class="docutils literal"><span class="pre">error</span></tt> and <tt class="docutils literal"><span class="pre">reason</span></tt> fields with error type and a human-friendly reason
description.</p>
<p>Document updating failure isn&#8217;t fatal as Target MAY reject the update for its
own reasons. It&#8217;s RECOMMENDED to use error type <tt class="docutils literal"><span class="pre">forbidden</span></tt> for rejections,
but other error types can also be used (like invalid field name etc.). The
Replicator SHOULD NOT retry uploading rejected documents unless there are
good reasons for doing so (e.g. there is special error type for that).</p>
<p>Note that while a update may fail for one Document in the response,
Target can still return a <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.2">201 Created</a> response. Same will be true if all
updates fail for all uploaded Documents.</p>
<blockquote>
<div><p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">246</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sun, 10 Nov 2013 19:02:26 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">[</span>
    <span class="p">{</span>
        <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot; 1-917fa2381192822767f010b95b45325b&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;FishStew&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-9c65296036141e575d32ba9c034dd3ee&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nt">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;forbidden&quot;</span><span class="p">,</span>
        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;LambStew&quot;</span><span class="p">,</span>
        <span class="nt">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;sorry&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-34c318924a8f327223eed702ddfdc66d&quot;</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="upload-document-with-attachments">
<h4>Upload Document with Attachments<a class="headerlink" href="#upload-document-with-attachments" title="Permalink to this headline">¶</a></h4>
<p>There is a special optimization case when then Replicator WILL NOT use bulk
upload of changed Documents. This case is applied when Documents contain a
lot of attached files or the files are too big to be efficiently encoded with
Base64.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">CouchDB defines a limit of <tt class="docutils literal"><span class="pre">8</span></tt> attachments per Document and each attached
file size should not be greater than <tt class="docutils literal"><span class="pre">64</span> <span class="pre">KiB</span></tt>. While this is a RECOMMENDED
limitation, other Replicator implementations MAY have their own values.</p>
</div>
<p>For this case the Replicator issues a <a class="reference internal" href="../api/document/common.html#put--db-docid" title="PUT /{db}/{docid}"><tt class="xref http http-put docutils literal"><span class="pre">/{db}/{docid}?new_edits=false</span></tt></a> request with <em class="mimetype">multipart/related</em> content type. Such
a request allows one to easily stream the Document and all its attachments
one by one without any serialization overhead.</p>
<blockquote>
<div><p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">PUT</span> <span class="nn">/target/SpaghettiWithMeatballs?new_edits=false</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">1030</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">multipart/related; boundary=&quot;864d690aeb91f25d469dec6851fb57f2&quot;</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">CouchDB</span>

--2fa48cba80d0cdba7829931fe8acce9d
Content-Type: application/json

{
    &quot;_attachments&quot;: {
        &quot;recipe.txt&quot;: {
            &quot;content_type&quot;: &quot;text/plain&quot;,
            &quot;digest&quot;: &quot;md5-R5CrCb6fX10Y46AqtNn0oQ==&quot;,
            &quot;follows&quot;: true,
            &quot;length&quot;: 87,
            &quot;revpos&quot;: 7
        }
    },
    &quot;_id&quot;: &quot;SpaghettiWithMeatballs&quot;,
    &quot;_rev&quot;: &quot;7-474f12eb068c717243487a9505f6123b&quot;,
    &quot;_revisions&quot;: {
        &quot;ids&quot;: [
            &quot;474f12eb068c717243487a9505f6123b&quot;,
            &quot;5949cfcd437e3ee22d2d98a26d1a83bf&quot;,
            &quot;00ecbbc54e2a171156ec345b77dfdf59&quot;,
            &quot;fc997b62794a6268f2636a4a176efcd6&quot;,
            &quot;3552c87351aadc1e4bea2461a1e8113a&quot;,
            &quot;404838bc2862ce76c6ebed046f9eb542&quot;,
            &quot;5defd9d813628cea6e98196eb0ee8594&quot;
        ],
        &quot;start&quot;: 7
    },
    &quot;description&quot;: &quot;An Italian-American delicious dish&quot;,
    &quot;ingredients&quot;: [
        &quot;spaghetti&quot;,
        &quot;tomato sauce&quot;,
        &quot;meatballs&quot;,
        &quot;love&quot;
    ],
    &quot;name&quot;: &quot;Spaghetti with meatballs&quot;
}
--2fa48cba80d0cdba7829931fe8acce9d
Content-Disposition: attachment; filename=&quot;recipe.txt&quot;
Content-Type: text/plain
Content-Length: 87

1. Cook spaghetti
2. Cook meetballs
3. Mix them
4. Add tomato sauce
5. ...
6. PROFIT!

--2fa48cba80d0cdba7829931fe8acce9d--
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">105</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Fri, 08 Nov 2013 16:35:27 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span>
    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;7-474f12eb068c717243487a9505f6123b&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>Unlike bulk updating via <a class="reference internal" href="../api/database/bulk-api.html#post--db-_bulk_docs" title="POST /{db}/_bulk_docs"><tt class="xref http http-post docutils literal"><span class="pre">POST</span> <span class="pre">/{db}/_bulk_docs</span></tt></a> endpoint, the response MAY
come with a different status code. For instance, in the case when the Document
is rejected, Target SHOULD respond with a <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.4">403 Forbidden</a>:</p>
<blockquote>
<div><p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">403</span> <span class="ne">Forbidden</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">39</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Fri, 08 Nov 2013 16:35:27 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;forbidden&quot;</span><span class="p">,</span>
    <span class="nt">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;sorry&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>Replicator SHOULD NOT retry requests in case of a <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a>,
<a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.4">403 Forbidden</a>, <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.10">409 Conflict</a> or <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.13">412 Precondition Failed</a> since repeating
the request couldn&#8217;t solve the issue with user credentials or uploaded data.</p>
</div>
<div class="section" id="ensure-in-commit">
<h4>Ensure In Commit<a class="headerlink" href="#ensure-in-commit" title="Permalink to this headline">¶</a></h4>
<p>Once a batch of changes has been successfully uploaded to Target, the
Replicator issues a <a class="reference internal" href="../api/database/compact.html#post--db-_ensure_full_commit" title="POST /{db}/_ensure_full_commit"><tt class="xref http http-post docutils literal"><span class="pre">POST</span> <span class="pre">/{db}/_ensure_full_commit</span></tt></a> request to ensure that
every transferred bit is laid down on disk or other <em>persistent</em> storage place.
Target MUST return <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.2">201 Created</a> response with a JSON object containing the
following mandatory fields:</p>
<ul>
<li><p class="first"><strong>instance_start_time</strong> (<em>string</em>): Timestamp of when the database was
opened, expressed in <em>microseconds</em> since the epoch</p>
</li>
<li><p class="first"><strong>ok</strong> (<em>boolean</em>): Operation status. Constantly <tt class="docutils literal"><span class="pre">true</span></tt></p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/target/_ensure_full_commit</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">53</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Web, 06 Nov 2013 18:20:43 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;instance_start_time&quot;</span><span class="p">:</span> <span class="s2">&quot;1381218659871282&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="record-replication-checkpoint">
<h4>Record Replication Checkpoint<a class="headerlink" href="#record-replication-checkpoint" title="Permalink to this headline">¶</a></h4>
<p>Since batches of changes were uploaded and committed successfully, the
Replicator updates the Replication Log both on Source and Target recording
the current Replication state. This operation is REQUIRED so that in the case
of Replication failure the replication can resume from last point of success,
not from the very beginning.</p>
<p>Replicator updates Replication Log on Source:</p>
<blockquote>
<div><p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">PUT</span> <span class="nn">/source/_local/afa899a9e59589c3d4ce5668e3218aef</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">591</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">CouchDB</span>

<span class="p">{</span>
    <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;_local/afa899a9e59589c3d4ce5668e3218aef&quot;</span><span class="p">,</span>
    <span class="nt">&quot;_rev&quot;</span><span class="p">:</span> <span class="s2">&quot;0-1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;_revisions&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;ids&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;31f36e40158e717fbe9842e227b389df&quot;</span>
        <span class="p">],</span>
        <span class="nt">&quot;start&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="nt">&quot;history&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;doc_write_failures&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;docs_read&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="nt">&quot;docs_written&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="nt">&quot;end_last_seq&quot;</span><span class="p">:</span> <span class="mi">26</span><span class="p">,</span>
            <span class="nt">&quot;end_time&quot;</span><span class="p">:</span> <span class="s2">&quot;Thu, 07 Nov 2013 09:42:17 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;missing_checked&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="nt">&quot;missing_found&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="nt">&quot;recorded_seq&quot;</span><span class="p">:</span> <span class="mi">26</span><span class="p">,</span>
            <span class="nt">&quot;session_id&quot;</span><span class="p">:</span> <span class="s2">&quot;04bf15bf1d9fa8ac1abc67d0c3e04f07&quot;</span><span class="p">,</span>
            <span class="nt">&quot;start_last_seq&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;start_time&quot;</span><span class="p">:</span> <span class="s2">&quot;Thu, 07 Nov 2013 09:41:43 GMT&quot;</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&quot;replication_id_version&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="nt">&quot;session_id&quot;</span><span class="p">:</span> <span class="s2">&quot;04bf15bf1d9fa8ac1abc67d0c3e04f07&quot;</span><span class="p">,</span>
    <span class="nt">&quot;source_last_seq&quot;</span><span class="p">:</span> <span class="mi">26</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">75</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Thu, 07 Nov 2013 09:42:17 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;_local/afa899a9e59589c3d4ce5668e3218aef&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;0-2&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>...and on Target too:</p>
<blockquote>
<div><p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">PUT</span> <span class="nn">/target/_local/afa899a9e59589c3d4ce5668e3218aef</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">591</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">CouchDB</span>

<span class="p">{</span>
    <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;_local/afa899a9e59589c3d4ce5668e3218aef&quot;</span><span class="p">,</span>
    <span class="nt">&quot;_rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-31f36e40158e717fbe9842e227b389df&quot;</span><span class="p">,</span>
    <span class="nt">&quot;_revisions&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;ids&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;31f36e40158e717fbe9842e227b389df&quot;</span>
        <span class="p">],</span>
        <span class="nt">&quot;start&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="nt">&quot;history&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;doc_write_failures&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;docs_read&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="nt">&quot;docs_written&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="nt">&quot;end_last_seq&quot;</span><span class="p">:</span> <span class="mi">26</span><span class="p">,</span>
            <span class="nt">&quot;end_time&quot;</span><span class="p">:</span> <span class="s2">&quot;Thu, 07 Nov 2013 09:42:17 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;missing_checked&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="nt">&quot;missing_found&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="nt">&quot;recorded_seq&quot;</span><span class="p">:</span> <span class="mi">26</span><span class="p">,</span>
            <span class="nt">&quot;session_id&quot;</span><span class="p">:</span> <span class="s2">&quot;04bf15bf1d9fa8ac1abc67d0c3e04f07&quot;</span><span class="p">,</span>
            <span class="nt">&quot;start_last_seq&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;start_time&quot;</span><span class="p">:</span> <span class="s2">&quot;Thu, 07 Nov 2013 09:41:43 GMT&quot;</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&quot;replication_id_version&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="nt">&quot;session_id&quot;</span><span class="p">:</span> <span class="s2">&quot;04bf15bf1d9fa8ac1abc67d0c3e04f07&quot;</span><span class="p">,</span>
    <span class="nt">&quot;source_last_seq&quot;</span><span class="p">:</span> <span class="mi">26</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">106</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Thu, 07 Nov 2013 09:42:17 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;_local/afa899a9e59589c3d4ce5668e3218aef&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;2-9b5d1e36bed6ae08611466e30af1259a&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="continue-reading-changes">
<h3>Continue Reading Changes<a class="headerlink" href="#continue-reading-changes" title="Permalink to this headline">¶</a></h3>
<p>Once a batch of changes had been processed and transferred to Target
successfully, the Replicator can continue to listen to the Changes Feed for new
changes. If there are no new changes to process the Replication is considered
to be done.</p>
<p>For Continuous Replication, the Replicator MUST continue to wait for new changes
from Source.</p>
</div>
</div>
<div class="section" id="protocol-robustness">
<h2>4.2.3. Protocol Robustness<a class="headerlink" href="#protocol-robustness" title="Permalink to this headline">¶</a></h2>
<p>Since the <cite>CouchDB Replication Protocol</cite> works on top of HTTP, which is based on
TCP/IP, the Replicator SHOULD expect to be working within an unstable
environment with delays, losses and other bad surprises that might eventually
occur. The Replicator SHOULD NOT count every HTTP request failure as a <em>fatal
error</em>. It SHOULD be smart enough to detect timeouts, repeat failed requests,
be ready to process incomplete or malformed data and so on. <em>Data must flow</em>
- that&#8217;s the rule.</p>
</div>
<div class="section" id="error-responses">
<h2>4.2.4. Error Responses<a class="headerlink" href="#error-responses" title="Permalink to this headline">¶</a></h2>
<p>In case something goes wrong the Peer MUST respond with a JSON object with
the following REQUIRED fields:</p>
<ul class="simple">
<li><strong>error</strong> (<em>string</em>): Error type for programs and developers</li>
<li><strong>reason</strong> (<em>string</em>): Error description for humans</li>
</ul>
<div class="section" id="bad-request">
<h3>Bad Request<a class="headerlink" href="#bad-request" title="Permalink to this headline">¶</a></h3>
<p>If a request contains malformed data (like invalid JSON) the Peer MUST respond
with a HTTP <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> and <tt class="docutils literal"><span class="pre">bad_request</span></tt> as error type:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;error&quot;</span><span class="o">:</span> <span class="s2">&quot;bad_request&quot;</span><span class="p">,</span>
    <span class="s2">&quot;reason&quot;</span><span class="o">:</span> <span class="s2">&quot;invalid json&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="unauthorized">
<h3>Unauthorized<a class="headerlink" href="#unauthorized" title="Permalink to this headline">¶</a></h3>
<p>If a Peer REQUIRES credentials be included with the request and the request
does not contain acceptable credentials then the Peer MUST respond with the
HTTP <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> and <tt class="docutils literal"><span class="pre">unauthorized</span></tt> as error type:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;error&quot;</span><span class="o">:</span> <span class="s2">&quot;unauthorized&quot;</span><span class="p">,</span>
    <span class="s2">&quot;reason&quot;</span><span class="o">:</span> <span class="s2">&quot;Name or password is incorrect&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="forbidden">
<h3>Forbidden<a class="headerlink" href="#forbidden" title="Permalink to this headline">¶</a></h3>
<p>If a Peer receives valid user credentials, but the requester does not have
sufficient permissions to perform the operation then the Peer
MUST respond with a HTTP <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.4">403 Forbidden</a> and <tt class="docutils literal"><span class="pre">forbidden</span></tt> as error type:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;error&quot;</span><span class="o">:</span> <span class="s2">&quot;forbidden&quot;</span><span class="p">,</span>
    <span class="s2">&quot;reason&quot;</span><span class="o">:</span> <span class="s2">&quot;You may only update your own user document.&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="resource-not-found">
<h3>Resource Not Found<a class="headerlink" href="#resource-not-found" title="Permalink to this headline">¶</a></h3>
<p>If the requested resource, Database or Document wasn&#8217;t found on a Peer, the Peer
MUST respond with a HTTP <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 Not Found</a> and <tt class="docutils literal"><span class="pre">not_found</span></tt> as error type:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;error&quot;</span><span class="o">:</span> <span class="s2">&quot;not_found&quot;</span><span class="p">,</span>
    <span class="s2">&quot;reason&quot;</span><span class="o">:</span> <span class="s2">&quot;database \&quot;target\&quot; does not exists&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="method-not-allowed">
<h3>Method Not Allowed<a class="headerlink" href="#method-not-allowed" title="Permalink to this headline">¶</a></h3>
<p>If an unsupported method was used then the Peer MUST respond with a
HTTP <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.6">405 Method Not Allowed</a> and <tt class="docutils literal"><span class="pre">method_not_allowed</span></tt> as error type:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;error&quot;</span><span class="o">:</span> <span class="s2">&quot;method_not_allowed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;reason&quot;</span><span class="o">:</span> <span class="s2">&quot;Only GET, PUT, DELETE allowed&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="resource-conflict">
<h3>Resource Conflict<a class="headerlink" href="#resource-conflict" title="Permalink to this headline">¶</a></h3>
<p>A resource conflict error occurs when there are concurrent updates of the same
resource by multiple clients. In this case the Peer MUST respond with a HTTP
<a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.10">409 Conflict</a> and <tt class="docutils literal"><span class="pre">conflict</span></tt> as error type:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;error&quot;</span><span class="o">:</span> <span class="s2">&quot;conflict&quot;</span><span class="p">,</span>
    <span class="s2">&quot;reason&quot;</span><span class="o">:</span> <span class="s2">&quot;document update conflict&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="precondition-failed">
<h3>Precondition Failed<a class="headerlink" href="#precondition-failed" title="Permalink to this headline">¶</a></h3>
<p>The HTTP <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.13">412 Precondition Failed</a> response may be sent in case of an attempt to
create a Database (error type <tt class="docutils literal"><span class="pre">db_exists</span></tt>) that already exists
or some attachment information is missing (error type <tt class="docutils literal"><span class="pre">missing_stub</span></tt>).
There is no explicit error type restrictions, but it is RECOMMEND to use error
types that are previously mentioned:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;error&quot;</span><span class="o">:</span> <span class="s2">&quot;db_exists&quot;</span><span class="p">,</span>
    <span class="s2">&quot;reason&quot;</span><span class="o">:</span> <span class="s2">&quot;database \&quot;target\&quot; exists&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="server-error">
<h3>Server Error<a class="headerlink" href="#server-error" title="Permalink to this headline">¶</a></h3>
<p>Raised in case an error is <em>fatal</em> and the Replicator cannot do anything to
continue Replication. In this case the Replicator MUST return a HTTP
<a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a> response with an error description (no restrictions on error
type applied):</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;error&quot;</span><span class="o">:</span> <span class="s2">&quot;worker_died&quot;</span><span class="p">,</span>
    <span class="s2">&quot;reason&quot;</span><span class="o">:</span> <span class="s2">&quot;kaboom!&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="optimisations">
<h2>4.2.5. Optimisations<a class="headerlink" href="#optimisations" title="Permalink to this headline">¶</a></h2>
<p>There are RECOMMENDED approaches to optimize the Replication process:</p>
<ul class="simple">
<li>Keep the number of HTTP requests at a reasonable minimum</li>
<li>Try to work with a connection pool and make parallel/multiple requests
whenever possible</li>
<li>Don&#8217;t close sockets after each request: respect the keep-alive option</li>
<li>Use continuous sessions (cookies, etc.) to reduce authentication overhead</li>
<li>Try to use bulk requests for every operations with Documents</li>
<li>Find out optimal batch size for Changes feed processing</li>
<li>Preserve Replication Logs and resume Replication from the last Checkpoint
whenever possible</li>
<li>Optimize filter functions: let them run as fast as possible</li>
<li>Get ready for surprises: networks are very unstable environments</li>
</ul>
</div>
<div class="section" id="api-reference">
<h2>4.2.6. API Reference<a class="headerlink" href="#api-reference" title="Permalink to this headline">¶</a></h2>
<div class="section" id="common-methods">
<h3>Common Methods<a class="headerlink" href="#common-methods" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference internal" href="../api/database/common.html#head--db" title="HEAD /{db}"><tt class="xref http http-head docutils literal"><span class="pre">HEAD</span> <span class="pre">/{db}</span></tt></a> &#8211; Check Database existence</li>
<li><a class="reference internal" href="../api/database/common.html#get--db" title="GET /{db}"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}</span></tt></a> &#8211; Retrieve Database information</li>
<li><a class="reference internal" href="../api/local.html#get--db-_local-docid" title="GET /{db}/_local/{docid}"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}/_local/{docid}</span></tt></a> &#8211; Read the last Checkpoint</li>
<li><a class="reference internal" href="../api/local.html#put--db-_local-docid" title="PUT /{db}/_local/{docid}"><tt class="xref http http-put docutils literal"><span class="pre">PUT</span> <span class="pre">/{db}/_local/{docid}</span></tt></a> &#8211; Save a new Checkpoint</li>
</ul>
</div>
<div class="section" id="for-target">
<h3>For Target<a class="headerlink" href="#for-target" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference internal" href="../api/database/common.html#put--db" title="PUT /{db}"><tt class="xref http http-put docutils literal"><span class="pre">PUT</span> <span class="pre">/{db}</span></tt></a> &#8211; Create Target if it not exists and the option was provided</li>
<li><a class="reference internal" href="../api/database/misc.html#post--db-_revs_diff" title="POST /{db}/_revs_diff"><tt class="xref http http-post docutils literal"><span class="pre">POST</span> <span class="pre">/{db}/_revs_diff</span></tt></a> &#8211; Locate Revisions that are not known to Target</li>
<li><a class="reference internal" href="../api/database/bulk-api.html#post--db-_bulk_docs" title="POST /{db}/_bulk_docs"><tt class="xref http http-post docutils literal"><span class="pre">POST</span> <span class="pre">/{db}/_bulk_docs</span></tt></a> &#8211; Upload Revisions to Target</li>
<li><a class="reference internal" href="../api/document/common.html#put--db-docid" title="PUT /{db}/{docid}"><tt class="xref http http-put docutils literal"><span class="pre">PUT</span> <span class="pre">/{db}/{docid}</span></tt></a> &#8211; Upload a single Document with attachments to Target</li>
<li><a class="reference internal" href="../api/database/compact.html#post--db-_ensure_full_commit" title="POST /{db}/_ensure_full_commit"><tt class="xref http http-post docutils literal"><span class="pre">POST</span> <span class="pre">/{db}/_ensure_full_commit</span></tt></a> &#8211; Ensure that all changes are stored
on disk</li>
</ul>
</div>
<div class="section" id="for-source">
<h3>For Source<a class="headerlink" href="#for-source" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference internal" href="../api/database/changes.html#get--db-_changes" title="GET /{db}/_changes"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}/_changes</span></tt></a> &#8211; Fetch changes since the last pull of Source</li>
<li><a class="reference internal" href="../api/database/changes.html#post--db-_changes" title="POST /{db}/_changes"><tt class="xref http http-post docutils literal"><span class="pre">POST</span> <span class="pre">/{db}/_changes</span></tt></a> &#8211; Fetch changes for specified Document IDs since
the last pull of Source</li>
<li><a class="reference internal" href="../api/document/common.html#get--db-docid" title="GET /{db}/{docid}"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}/{docid}</span></tt></a> &#8211; Retrieve a single Document from Source
with attachments</li>
</ul>
</div>
</div>
<div class="section" id="reference">
<h2>4.2.7. Reference<a class="headerlink" href="#reference" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/refuge/rcouch/wiki/Replication-Algorithm">Refuge RCouch wiki</a></li>
<li><a class="reference external" href="https://github.com/couchbase/couchbase-lite-ios/wiki/Replication-Algorithm">CouchBase Lite IOS wiki</a></li>
<li><a class="reference external" href="http://wiki.apache.org/couchdb/Replication">CouchDB documentation</a></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
    <p class="logo"><a href="../index.html">
      <img class="logo" src="../_static/logo.png" alt="Logo"/>
    </a></p><!--

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed
under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.

-->

<div id="searchbox" style="display: none">

<h3>Quick Search</h3>

<form class="search" action="../search.html" method="get">
<input type="text" name="q" style="width:115px">
<input type="submit" value="Go">
<input type="hidden" name="check_keywords" value="yes">
<input type="hidden" name="area" value="default">
</form>

<br>

</div>

<script type="text/javascript">$('#searchbox').show(0);</script>
  <h3><a href="../contents.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">4.2. CouchDB Replication Protocol</a><ul>
<li><a class="reference internal" href="#preface">4.2.1. Preface</a><ul>
<li><a class="reference internal" href="#language">Language</a></li>
<li><a class="reference internal" href="#goals">Goals</a></li>
<li><a class="reference internal" href="#definitions">Definitions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#replication-protocol-algorithm">4.2.2. Replication Protocol Algorithm</a><ul>
<li><a class="reference internal" href="#verify-peers">Verify Peers</a><ul>
<li><a class="reference internal" href="#check-source-existence">Check Source Existence</a></li>
<li><a class="reference internal" href="#check-target-existence">Check Target Existence</a></li>
<li><a class="reference internal" href="#create-target">Create Target?</a></li>
<li><a class="reference internal" href="#abort">Abort</a></li>
</ul>
</li>
<li><a class="reference internal" href="#get-peers-information">Get Peers Information</a><ul>
<li><a class="reference internal" href="#get-source-information">Get Source Information</a></li>
<li><a class="reference internal" href="#get-target-information">Get Target Information</a></li>
</ul>
</li>
<li><a class="reference internal" href="#find-common-ancestry">Find Common Ancestry</a><ul>
<li><a class="reference internal" href="#generate-replication-id">Generate Replication ID</a></li>
<li><a class="reference internal" href="#retrieve-replication-logs-from-source-and-target">Retrieve Replication Logs from Source and Target</a></li>
<li><a class="reference internal" href="#compare-replication-logs">Compare Replication Logs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#locate-changed-documents">Locate Changed Documents</a><ul>
<li><a class="reference internal" href="#listen-to-changes-feed">Listen to Changes Feed</a></li>
<li><a class="reference internal" href="#read-batch-of-changes">Read Batch of Changes</a></li>
<li><a class="reference internal" href="#calculate-revision-difference">Calculate Revision Difference</a></li>
<li><a class="reference internal" href="#replication-completed">Replication Completed</a></li>
</ul>
</li>
<li><a class="reference internal" href="#replicate-changes">Replicate Changes</a><ul>
<li><a class="reference internal" href="#fetch-changed-documents">Fetch Changed Documents</a></li>
<li><a class="reference internal" href="#upload-batch-of-changed-documents">Upload Batch of Changed Documents</a></li>
<li><a class="reference internal" href="#upload-document-with-attachments">Upload Document with Attachments</a></li>
<li><a class="reference internal" href="#ensure-in-commit">Ensure In Commit</a></li>
<li><a class="reference internal" href="#record-replication-checkpoint">Record Replication Checkpoint</a></li>
</ul>
</li>
<li><a class="reference internal" href="#continue-reading-changes">Continue Reading Changes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#protocol-robustness">4.2.3. Protocol Robustness</a></li>
<li><a class="reference internal" href="#error-responses">4.2.4. Error Responses</a><ul>
<li><a class="reference internal" href="#bad-request">Bad Request</a></li>
<li><a class="reference internal" href="#unauthorized">Unauthorized</a></li>
<li><a class="reference internal" href="#forbidden">Forbidden</a></li>
<li><a class="reference internal" href="#resource-not-found">Resource Not Found</a></li>
<li><a class="reference internal" href="#method-not-allowed">Method Not Allowed</a></li>
<li><a class="reference internal" href="#resource-conflict">Resource Conflict</a></li>
<li><a class="reference internal" href="#precondition-failed">Precondition Failed</a></li>
<li><a class="reference internal" href="#server-error">Server Error</a></li>
</ul>
</li>
<li><a class="reference internal" href="#optimisations">4.2.5. Optimisations</a></li>
<li><a class="reference internal" href="#api-reference">4.2.6. API Reference</a><ul>
<li><a class="reference internal" href="#common-methods">Common Methods</a></li>
<li><a class="reference internal" href="#for-target">For Target</a></li>
<li><a class="reference internal" href="#for-source">For Source</a></li>
</ul>
</li>
<li><a class="reference internal" href="#reference">4.2.7. Reference</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="intro.html"
                        title="previous chapter">4.1. Introduction to Replication</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="replicator.html"
                        title="next chapter">4.3. Replicator Database</a></p><!--

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed
under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.

-->


<h3>Utilities</h3>

<ul>
<li><a href="../">Fauxton</a></li>
</ul>
<!--

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed
under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.

-->

<h3>More Help</h3>

<ul>
<li><a href="https://couchdb.apache.org/">Homepage</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/COUCHDB/">Wiki</a></li>
<li><a href="https://couchdb.apache.org/#mailing-list">Mailing Lists</a></li>
<li><a href="http://webchat.freenode.net/?channels=couchdb">IRC</a></li>
<li><a href="https://issues.apache.org/jira/browse/CouchDB">Issues</a></li>
<li><a href="../download.html">Download</a></li>
<li><a href="https://github.com/apache/couchdb-documentation/blob/master/src/replication/protocol.rst"
       rel="nofollow">Show on GitHub</a></li>
<li><a href="https://github.com/apache/couchdb-documentation/edit/master/src/replication/protocol.rst"
       rel="nofollow">Edit on GitHub</a></li>
</ul><!--

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed
under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.

-->


        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../http-api.html" title="HTTP API Reference"
             >API Reference</a></li>
        <li class="right" >
          <a href="../config-ref.html" title="Configuration Reference"
             >Config Reference</a> |</li>
        <li class="right" >
          <a href="replicator.html" title="4.3. Replicator Database"
             >next</a> |</li>
        <li class="right" >
          <a href="intro.html" title="4.1. Introduction to Replication"
             >previous</a> |</li>
  <li><a href="../index.html">Apache CouchDB 2.0 Documentation</a> &raquo;</li>
          <li><a href="index.html" >4. Replication</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2016, Apache Software Foundation.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>